<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Profile</title>
    <style>
      /* Updated and new styles */
      :root {
        --primary-color: #2a2f4c;
        --secondary-color: #1a73e8;
        --background-color: #1f2233;
        --card-background: #2a2f4c;
        --text-color: #ffffff;
      }

      body {
        font-family: 'Press Start 2P', cursive;
        margin: 0;
        padding: 20px;
        background-color: var(--background-color);
        color: var(--text-color);
        line-height: 1.6;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      /* Enhanced Login Form */
      .login-container {
        max-width: 400px;
        margin: 100px auto;
        padding: 30px;
        background: var(--card-background);
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .login-container h2 {
        text-align: center;
        color: var(--text-color);
        margin-bottom: 30px;
        font-size: 2em;
      }

      .form-group {
        margin-bottom: 20px;
      }

      input {
        width: 100%;
        padding: 12px;
        margin-top: 8px;
        border: none;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-color);
        font-size: 16px;
        transition: all 0.3s ease;
      }

      input:focus {
        outline: none;
        background: rgba(255, 255, 255, 0.15);
        box-shadow: 0 0 10px rgba(26, 115, 232, 0.5);
      }

      button {
        width: 100%;
        padding: 12px;
        background: var(--secondary-color);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        transition: all 0.3s ease;
      }

      button:hover {
        background: #1557b0;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(26, 115, 232, 0.4);
      }

      /* Profile Container Styling */
      .profile-container {
        display: none;
        background: var(--card-background);
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
      }

      /* Welcome Message Animation */
      .welcome-message {
        font-size: 2.5em;
        font-weight: bold;
        text-align: center;
        margin: 20px 0;
        background: linear-gradient(
          90deg,
          #ff0000,
          #ff7f00,
          #ffff00,
          #00ff00,
          #0000ff,
          #4b0082,
          #8f00ff
        );
        background-size: 200% auto;
        color: #fff;
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: rainbow 6s linear infinite;
      }

      @keyframes rainbow {
        0% {
          background-position: 0% 50%;
        }
        100% {
          background-position: 200% 50%;
        }
      }

      .graphs-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 40px;
        margin-top: 40px;
      }

      .graph {
        background: rgba(255, 255, 255, 0.05);
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        min-height: 500px;
      }

      .graph h3 {
        color: var(--text-color);
        margin-bottom: 20px;
        text-align: center;
      }

      .error {
        color: #ff4444;
        margin-top: 10px;
        text-align: center;
        font-weight: bold;
      }

      /* Stats Cards */
      .stats-card {
        background: rgba(255, 255, 255, 0.05);
        padding: 15px;
        border-radius: 10px;
        margin: 10px 0;
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: transform 0.3s ease;
      }

      .stats-card:hover {
        transform: translateY(-5px);
      }

      /* Responsive Design */
      @media (max-width: 1200px) {
        .container {
          max-width: 95%;
        }
      }

      @media (max-width: 768px) {
        .graphs-container {
          grid-template-columns: 1fr;
        }

        .graph {
          min-height: 400px;
        }
      }
    </style>
  </head>
  <body>
    <link
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
      rel="stylesheet"
    />
    <div class="container">
      <!-- Login Form -->
      <div id="loginContainer" class="login-container">
        <h2>Login</h2>
        <div class="form-group">
          <input type="text" id="username" placeholder="Username or Email" />
        </div>
        <div class="form-group">
          <input type="password" id="password" placeholder="Password" />
        </div>
        <button onclick="login()">Login</button>
        <div id="loginError" class="error"></div>
      </div>

      <!-- Profile Section -->
      <div id="profileContainer" class="profile-container">
        <button onclick="logout()" style="width: auto; float: right">
          Logout
        </button>
        <h1>Student Profile</h1>
        <div id="basicInfo"></div>

        <div class="graphs-container">
          <div class="graph">
            <h3>XP Progress Over Time</h3>
            <svg id="xpGraph" width="100%" height="500"></svg>
          </div>
          <div class="graph">
            <h3>Audit Ratio</h3>
            <svg id="auditGraph" width="100%" height="400"></svg>
          </div>
        </div>
      </div>
    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
      const API_URL =
        'https://learn.reboot01.com/api/graphql-engine/v1/graphql';
      const AUTH_URL = 'https://learn.reboot01.com/api/auth/signin';
      let jwt = localStorage.getItem('jwt');

      // Check if already logged in
      if (jwt) {
        showProfile();
      }

      async function login() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const credentials = btoa(`${username}:${password}`);

        try {
          const response = await fetch(AUTH_URL, {
            method: 'POST',
            headers: {
              Authorization: `Basic ${credentials}`,
            },
          });

          if (!response.ok) {
            throw new Error('Invalid credentials');
          }

          const data = await response.json();
          jwt = data;
          localStorage.setItem('jwt', jwt);
          showProfile();
        } catch (error) {
          document.getElementById('loginError').textContent = error.message;
        }
      }

      function logout() {
        localStorage.removeItem('jwt');
        location.reload();
      }

      async function fetchGraphQLData(query) {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${jwt}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ query }),
        });
        return response.json();
      }

      async function showProfile() {
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('profileContainer').style.display = 'block';

        // Fetch user data
        const query = `
                query {
                    user {
                        id
                        login
                        firstName
                        lastName
                        totalUp
                        totalDown
                        progresses(order_by: {updatedAt: desc}) {
                            object {
                                name
                            }
                            updatedAt
                            grade
                        }
                        transactions(where: {type: {_eq: "xp"}, eventId: {_is_null: false}}, order_by: {createdAt: asc}) {
                            amount
                            createdAt
                            path
                        }
                    }
                }
            `;

        try {
          const data = await fetchGraphQLData(query);
          const user = data.data.user[0];

          // Display basic info
          document.getElementById('basicInfo').innerHTML = `
                    <div class="welcome-message">Welcome, ${user.firstName} ${
            user.lastName
          }!</div>
                    <table class="user-info-table">
                        <tr>
                            <td><strong>ID:</strong></td>
                            <td>${user.login}</td>
                        </tr>
                        <tr>
                            <td><strong>Full Name:</strong></td>
                            <td>${user.firstName} ${user.lastName}</td>
                        </tr>
                        <tr>
                            <td><strong>Username:</strong></td>
                            <td>${user.login}</td>
                        </tr>
                        <tr>
                            <td><strong>Campus:</strong></td>
                            <td>Bahrain</td>
                        </tr>
                       
                        <tr>
                            <td><strong>Last Project:</strong></td>
                            <td>${
                              user.progresses[0]
                                ? `${
                                    user.progresses[0].object.name
                                  } (${new Date(
                                    user.progresses[0].updatedAt
                                  ).toLocaleString()})`
                                : 'No projects yet'
                            }</td>
                        </tr>
                    
                        <p>Total XP: ${Math.round(user.totalUp / 1000)} kB</p>
                        
                    </table>
                `;

          // Draw XP progress graph
          drawXPGraph(user.transactions);

          // Draw audit ratio graph
          drawAuditPieChart(user.totalUp, user.totalDown);
        } catch (error) {
          console.error('Error fetching data:', error);
        }
      }

      function drawXPGraph(transactions) {
        const svg = d3.select('#xpGraph');
        svg.selectAll('*').remove();

        const margin = {top: 50, right: 60, bottom: 90, left: 100};
        const width = 1000 - margin.left - margin.right;
        const height = 600 - margin.top - margin.bottom;

        svg.attr("viewBox", `0 0 1000 600`)
           .attr("preserveAspectRatio", "xMidYMid meet");

        const g = svg
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // Process and sort data
        const data = transactions
            .map(t => ({
                date: new Date(t.createdAt),
                xp: t.amount / 1000,
                path: t.path
            }))
            .sort((a, b) => a.date - b.date);

        // Create scales with sorted dates
        const x = d3.scaleTime()
            .domain(d3.extent(data, d => d.date))
            .range([0, width]);

        const y = d3.scaleLinear()
            .domain([0, d3.max(data, d => d.xp) * 1.2])
            .range([height, 0]);

        // Add gradient definition
        const gradient = svg.append("defs")
            .append("linearGradient")
            .attr("id", "bar-gradient")
            .attr("gradientUnits", "userSpaceOnUse")
            .attr("x1", "0%")
            .attr("y1", "0%")
            .attr("x2", "0%")
            .attr("y2", "100%");

        gradient.append("stop")
            .attr("offset", "0%")
            .attr("stop-color", "#64b5f6");

        gradient.append("stop")
            .attr("offset", "100%")
            .attr("stop-color", "#1a73e8");

        // Add styled X axis with 4-month intervals
        g.append("g")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(x)
                .tickFormat(d3.timeFormat("%b %Y"))
                .ticks(d3.timeMonth.every(4)))  // Show every 4 months
            .selectAll("text")
            .style("fill", "#ffffff")
            .style("font-size", "14px")
            .style("font-weight", "bold")
            .attr("transform", "rotate(-45)")
            .attr("text-anchor", "end");

        // Add styled Y axis
        g.append("g")
            .call(d3.axisLeft(y)
                .tickFormat(d => `${Math.round(d)}kB`)
                .ticks(10))
            .selectAll("text")
            .style("fill", "#ffffff")
            .style("font-size", "14px")
            .style("font-weight", "bold");

        // Calculate bar width
        const barWidth = width / data.length * 0.8;  // 80% of available space per bar

        // Add bars with enhanced styling
        const bars = g.selectAll(".bar")
            .data(data)
            .enter()
            .append("rect")
            .attr("class", "bar")
            .attr("x", d => x(d.date) - barWidth/2)  // Center the bar on the date
            .attr("y", d => y(d.xp))
            .attr("width", barWidth)
            .attr("height", d => height - y(d.xp))
            .attr("fill", "url(#bar-gradient)")
            .attr("rx", 12)
            .attr("ry", 12)
            .style("filter", "drop-shadow(0px 4px 6px rgba(0,0,0,0.2))");

        // Enhanced hover effect
        bars.on("mouseover", function(event, d) {
            d3.select(this)
                .transition()
                .duration(300)
                .attr("fill", "#64b5f6")
                .style("filter", "drop-shadow(0px 8px 12px rgba(0,0,0,0.4))")
                .attr("transform", "translateY(-5px)");

            // Enhanced tooltip
            g.append("text")
                .attr("class", "tooltip")
                .attr("x", x(d.date))
                .attr("y", y(d.xp) - 20)
                .attr("text-anchor", "middle")
                .style("fill", "#ffffff")
                .style("font-size", "16px")
                .style("font-weight", "bold")
                .style("text-shadow", "2px 2px 4px rgba(0,0,0,0.3)")
                .text(`${Math.round(d.xp)}kB - ${d.path}`);
        })
        .on("mouseout", function() {
            d3.select(this)
                .transition()
                .duration(300)
                .attr("fill", "url(#bar-gradient)")
                .style("filter", "drop-shadow(0px 4px 6px rgba(0,0,0,0.2))")
                .attr("transform", "translateY(0)");
            
            g.selectAll(".tooltip").remove();
        });

        // Enhanced axis labels
        g.append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 0 - margin.left + 30)
            .attr("x", 0 - (height / 2))
            .attr("dy", "1em")
            .style("text-anchor", "middle")
            .style("fill", "#ffffff")
            .style("font-size", "18px")
            .style("font-weight", "bold")
            .text("XP (kB)");

        // Add X axis label
        g.append("text")
            .attr("x", width / 2)
            .attr("y", height + margin.bottom - 20)
            .style("text-anchor", "middle")
            .style("fill", "#ffffff")
            .style("font-size", "18px")
            .style("font-weight", "bold")
            .text("Date");

        // Style axis lines
        svg.selectAll(".domain, .tick line")
            .style("stroke", "#ffffff")
            .style("stroke-width", "2px");

        // Add subtle grid lines
        g.selectAll("g.y-axis g.tick")
            .append("line")
            .attr("class", "grid-line")
            .attr("x2", width)
            .style("stroke", "rgba(255, 255, 255, 0.1)")
            .style("stroke-width", "1px");
      }

      function drawAuditPieChart(up, down) {
        const svg = d3.select('#auditGraph');
        svg.selectAll('*').remove();

        // Update SVG viewBox for better scaling
        svg
          .attr('viewBox', `0 0 500 400`)
          .attr('preserveAspectRatio', 'xMidYMid meet');

        const width = 500;
        const height = 400;
        const radius = Math.min(width, height) / 2.5;

        const total = up + down;
        const upRatio = up / total;
        const downRatio = down / total;

        const centerX = width / 2;
        const centerY = height / 2;

        // Convert ratio to angles
        const upAngle = upRatio * 360;
        const downAngle = downRatio * 360;

        // Create pie slices
        const createSlice = (startAngle, endAngle, color) => {
          const start = polarToCartesian(centerX, centerY, radius, startAngle);
          const end = polarToCartesian(centerX, centerY, radius, endAngle);
          const largeArcFlag = endAngle - startAngle <= 180 ? 0 : 1;

          const path = [
            'M',
            centerX,
            centerY,
            'L',
            start.x,
            start.y,
            'A',
            radius,
            radius,
            0,
            largeArcFlag,
            1,
            end.x,
            end.y,
            'Z',
          ].join(' ');

          const slice = document.createElementNS(
            'http://www.w3.org/2000/svg',
            'path'
          );
          slice.setAttribute('d', path);
          slice.setAttribute('fill', color);
          return slice;
        };

        svg.node().appendChild(createSlice(0, upAngle, '#4CAF50'));
        svg.node().appendChild(createSlice(upAngle, 360, '#F44336'));

        // Add legend
        addLegendItem(
          svg,
          350,
          120,
          '#4CAF50',
          `Up (${Math.round(upRatio * 100)}%)`
        );
        addLegendItem(
          svg,
          350,
          150,
          '#F44336',
          `Down (${Math.round(downRatio * 100)}%)`
        );
      }

      function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
        const angleInRadians = ((angleInDegrees - 90) * Math.PI) / 180.0;
        return {
          x: centerX + radius * Math.cos(angleInRadians),
          y: centerY + radius * Math.sin(angleInRadians),
        };
      }

      function addLegendItem(svg, x, y, color, text) {
        const rect = document.createElementNS(
          'http://www.w3.org/2000/svg',
          'rect'
        );
        rect.setAttribute('x', x);
        rect.setAttribute('y', y - 10);
        rect.setAttribute('width', 20);
        rect.setAttribute('height', 20);
        rect.setAttribute('fill', color);
        svg.node().appendChild(rect);

        const label = document.createElementNS(
          'http://www.w3.org/2000/svg',
          'text'
        );
        label.setAttribute('x', x + 30);
        label.setAttribute('y', y + 5);
        label.textContent = text;
        svg.node().appendChild(label);
      }
    </script>
  </body>
</html>
